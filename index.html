<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vue-api</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <section v-if="loading">
            loading...
        </section>
        <section v-else>
            <div class="container">
                <div class="title">
                    <div class="input">
                        <input type="text" placeholder="name" v-model.trim='input.name'>
                        <input type="text" placeholder="e-mail" v-model.trim='input.email'>
                        <button @click='sendHandler'>send</button>
                        <button @click='cancelHandler'>cancel</button>
                    </div>
                </div>
                
                <div class="list">
                    <div class="listItem" v-for='(item,index) in contacts'>
                        <span class="number">{{ item.id }}</span>
                        <span class="name">{{ item.name }}</span>
                        <a href="#">{{ item.email }}</a>
                        <span class="edit" @click='changeHandler(index)'>change</span>
                        <span class="edit" @click='deleteHandler(index)'>delete</span>
                    </div>
                </div>   
            </div>
        </section>     
    </div>
</body>
<script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.9.1/axios.min.js' integrity='sha512-Xk3wWei2TGrsh9kDSBKUMIjw/86sLUvhtnv9f7fOuIwhhiUTKz8szkWkzHthrM5Bb3Bu9idSzkxOrkzhcneuiw==' crossorigin='anonymous'></script>
<script src="https://unpkg.com/vue@next"></script>
<script>
        ;(function(Vue){
            Vue.createApp({
            data(){
                return{
                    loading:false,
                    editIndex:null,
                    contacts:[],
                    input:{
                        name:'',
                        email:''
                    }
                }
            },
            methods:{
                sendHandler(){
                    let {name,email} = this.input
                    if(!name || !email) return
                    this.loading=true
                    if (this.editIndex == null){
                        axios.post('http://localhost:5000/contact',this.input)
                    .then((res)=>{
                        console.log(res)
                        this.contacts.push(res.data)
                        this.cancelHandler()
                        this.loading=false
                    }).catch((err)=>{
                        console.log(err)
                    }) 
                    }else{
                        // let id = this.contacts[this.editIndex].id
                        let {id} = this.contacts[this.editIndex]
                        axios.put('http://localhost:5000/contact/'+id,this.input)
                        .then((res)=>{
                            this.contacts[this.editIndex]=res.data
                            this.cancelHandler()
                            this.loading=false
                        })
                        .catch((err)=>{
                            console.log(err)
                        })
                    }
                    },
                cancelHandler(){
                    this.editIndex=null
                    this.input.name=''
                    this.input.email=''
                },
                changeHandler(index){
                    let {name,email} = this.contacts[index]
                    this.editIndex =index
                    this.input.name=name
                    this.input.email=email 
                },
                deleteHandler(index){
                    let target = this.contacts[index]
                    this.loading=true
                    if(confirm(`You want delete ${target.name}'data ?`)){
                        axios.delete('http://localhost:5000/contact/'+target.id)
                        .then((res)=>{this.contacts.splice(index,1)
                            this.loading=false})
                            this.cancelIdleCallback()
                        .catch((err)=>{console.log(err)})  
                    }   
                }
            },
            mounted(){
                this.loading = true
                axios.get('http://localhost:5000/contact')
                .then((res)=>{
                    console.log(res)
                    this.contacts=res.data
                    this.loading=false
                }).catch((err)=>{
                    console.log(err)
                }) 
            }   
        }).mount('#app')
        })(Vue)       
</script>
</html>